### 6ç§é€šä¿¡è·¯å¾„ï¼š

1. popupå’Œbackgroundä¹‹é—´çš„é€šä¿¡
   1. `background`ç»™`popup`å‘é€æ¶ˆæ¯
   2. `popup`ç»™`background`å‘é€æ¶ˆæ¯
2. backgroundå’Œcontentä¹‹é—´çš„é€šä¿¡
   1. `background`ç»™`content`å‘é€æ¶ˆæ¯
   2. `content`ç»™`background`å‘é€æ¶ˆæ¯
3. popupå’Œcontentä¹‹é—´çš„é€šä¿¡
   1. `popup`ç»™`content`å‘é€æ¶ˆæ¯
   2. `content`ç»™`popup`å‘é€æ¶ˆæ¯

|                 | injected-script                       | content-script                              | background-js                                     | popup-js                                          |
| --------------- | :------------------------------------ | ------------------------------------------- | ------------------------------------------------- | ------------------------------------------------- |
| injected-script | -                                     | window.postMessage                          | -                                                 | -                                                 |
| content-script  | window.postMessage                    | -                                           | chrome.runtime.sendMessage chrome.runtime.connect | chrome.runtime.sendMessage chrome.runtime.connect |
| popup-js        | -                                     | chrome.tabs.sendMessage chrome.tabs.connect | chrome.extension. getBackgroundPage()             | -                                                 |
| background-js   | -                                     | chrome.tabs.sendMessage chrome.tabs.connect | -                                                 | chrome.extension.getViews                         |
| devtools-js     | chrome.devtools. inspectedWindow.eval | -                                           | chrome.runtime.sendMessage                        | chrome.runtime.sendMessage                        |

### `popup`å’Œ`background`ä¹‹é—´çš„é€šä¿¡

#### `background`ç»™`popup`å‘é€æ¶ˆæ¯

~~~js
// background.js
function toPopup() {
    alert('to popup!')
}
// popup.js
const bg = chrome.extension.getBackgroundPage()
document.getElementById('rBgInfo').onclick = function() {
    bg.toPopup()
}
~~~

#### `popup`ç»™`background`å‘é€æ¶ˆæ¯

~~~js
// popup.js
// ä½¿ç”¨é•¿è¿æ¥
let port = chrome.extension.connect({
    name: 'popup-name'
})

// ä½¿ç”¨postMs å‘é€ä¿¡æ¯
port.postMessage('ç»™ background ä¼ é€’ä¿¡æ¯~')

// æ¥æ”¶ä¿¡æ¯
port.onMessage.addListener(msg => {
    console.log('æ¥æ”¶çš„ä¿¡æ¯ï¼š', msg)
})

// background.js
// è·å–æ‰€æœ‰ tab
const pups = chrome.extension.getViews({
    type: 'popup'
}) || []

// è¾“å‡ºç¬¬ä¸€ä¸ªä½¿ç”¨æ’ä»¶é¡µé¢çš„url
if (pups.length) {
    console.log(pups[0].location.href)
}

~~~

### `popup`å’Œ`content`ä¹‹é—´çš„é€šä¿¡

`manifest`æ·»åŠ ä¸‹åˆ—é…ç½®

```js
{
    ...
    "content_scripts": [
        {
            "matches": [
                "<all_urls>"
            ],
            "js": [
                "content.js"
            ]
        }
    ]
}
```

#### `content`ç»™`popup`å‘é€æ¶ˆæ¯

é¦–å…ˆåœ¨content.jsæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

~~~js
// Chromeæä¾›çš„å¤§éƒ¨åˆ†APIæ˜¯ä¸æ”¯æŒåœ¨content_scriptsä¸­è¿è¡Œ
// sendMessage onMessage æ˜¯å¯ä»¥ä½¿ç”¨
chrome.runtime.sendMessage({
    info: "æˆ‘æ˜¯ content.js"
}, res => {
    // ç­”å¤
    alert(res)
})
~~~

ä»£ç è´Ÿè´£å‘é€ä¿¡æ¯å’Œæ¥æ”¶åé¦ˆï¼Œç„¶åç»™`popup.js`æ·»åŠ ï¼š

~~~js
// popup.js
chrome.runtime.onMessage.addListener((req,sender, sendResponse) => {
    sendResponse('æˆ‘æ”¶åˆ°äº†ä½ çš„æ¥ä¿¡')
    console.log('æ¥æ”¶äº†æ¥è‡ª content.jsçš„æ¶ˆæ¯', req.info)
})

~~~

ä»£ç è´Ÿè´£æ¥æ”¶æ¶ˆæ¯å’Œå‘é€åé¦ˆ

#### `popup`ç»™`content`å‘é€æ¶ˆæ¯

~~~js
// popup.js
// popup ---> content
chrome.tabs.query({
    active: true,
    currentWindow: true
}, (tabs) => {
    let message = {
        info: 'æ¥è‡ªpopupçš„æƒ…ä¹¦ğŸ’Œ'
    }
    chrome.tabs.sendMessage(tabs[0].id, message, res => {
        console.log('popup=>content')
        console.log(res)
    })
})

~~~

~~~js
// content.js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    console.log(request.info)
    sendResponse('æˆ‘æ”¶åˆ°äº†ä½ çš„æƒ…ä¹¦ï¼Œpopup~')
})

~~~

### `background`å’Œ`content`ä¹‹é—´çš„é€šä¿¡

`background`å’Œ`content`ä¹‹é—´çš„é€šä¿¡ä¸`popup`å’Œ`content`ç±»ä¼¼çš„ï¼Œä¸ä¸Šé¢ä¸€æ ·ã€‚

### é•¿è¿æ¥ä¸çŸ­è¿æ¥

åœ¨ä¸Šé¢çš„ä¸€äº›demoä¸­ï¼Œå¯ä»¥çœ‹åˆ°é€šä¿¡ä½¿ç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå°±æ˜¯`sendMessage`ï¼Œå¦ä¸€ä¸ªå°±æ˜¯`connect`ï¼Œå…¶å®è¿™ä¸¤ä¸ªåˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„è¿æ¥æ–¹å¼ï¼š

- é•¿è¿æ¥ï¼š `chrome.tabs.connect` å’Œ `chrome.runtime.connect`
- çŸ­è¿æ¥ï¼š `chrome.tabs.sendMessage`

------

popup.jsï¼š

```jsx
getCurrentTabId((tabId) => {
    var port = chrome.tabs.connect(tabId, {name: 'test-connect'});
    port.postMessage({question: 'ä½ æ˜¯è°å•Šï¼Ÿ'});
    port.onMessage.addListener(function(msg) {
        alert('æ”¶åˆ°æ¶ˆæ¯ï¼š'+msg.answer);
        if(msg.answer && msg.answer.startsWith('æˆ‘æ˜¯'))
        {
            port.postMessage({question: 'å“¦ï¼ŒåŸæ¥æ˜¯ä½ å•Šï¼'});
        }
    });
});
```

content-script.jsï¼š

```jsx
// ç›‘å¬é•¿è¿æ¥
chrome.runtime.onConnect.addListener(function(port) {
    console.log(port);
    if(port.name == 'test-connect') {
        port.onMessage.addListener(function(msg) {
            console.log('æ”¶åˆ°é•¿è¿æ¥æ¶ˆæ¯ï¼š', msg);
            if(msg.question == 'ä½ æ˜¯è°å•Šï¼Ÿ') port.postMessage({answer: 'æˆ‘æ˜¯ä½ çˆ¸ï¼'});
        });
    }
});
```

